<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>class Keymap::ConnectionAdapters::ConnectionPool - keymap 0.3.2</title>

<link type="text/css" media="screen" href="../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="../../index.html">Home</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>lib/keymap/connection_adapters/abstract/connection_pool.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link">Object
  
</nav>

    <!-- Included Modules -->
<nav id="includes-section" class="section">
  <h3 class="section-header">Included Modules</h3>

  <ul class="link-list">
  
  
    <li><span class="include">MonitorMixin</span>
  
  
  </ul>
</nav>

    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-new">::new</a>
    
    <li><a href="#method-i-active_connection-3F">#active_connection?</a>
    
    <li><a href="#method-i-active_connections">#active_connections</a>
    
    <li><a href="#method-i-checkin">#checkin</a>
    
    <li><a href="#method-i-checkout">#checkout</a>
    
    <li><a href="#method-i-checkout_and_verify">#checkout_and_verify</a>
    
    <li><a href="#method-i-checkout_new_connection">#checkout_new_connection</a>
    
    <li><a href="#method-i-clear_reloadable_connections-21">#clear_reloadable_connections!</a>
    
    <li><a href="#method-i-clear_stale_cached_connections-21">#clear_stale_cached_connections!</a>
    
    <li><a href="#method-i-connected-3F">#connected?</a>
    
    <li><a href="#method-i-connection">#connection</a>
    
    <li><a href="#method-i-disconnect-21">#disconnect!</a>
    
    <li><a href="#method-i-new_connection">#new_connection</a>
    
    <li><a href="#method-i-release">#release</a>
    
    <li><a href="#method-i-release_connection">#release_connection</a>
    
    <li><a href="#method-i-with_connection">#with_connection</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="../../README_rdoc.html">README</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="../../Keymap.html">Keymap</a>
  
    <li><a href="../../Keymap/AdapterNotFound.html">Keymap::AdapterNotFound</a>
  
    <li><a href="../../Keymap/AdapterNotSpecified.html">Keymap::AdapterNotSpecified</a>
  
    <li><a href="../../Keymap/Base.html">Keymap::Base</a>
  
    <li><a href="../../Keymap/ConnectionAdapters.html">Keymap::ConnectionAdapters</a>
  
    <li><a href="../../Keymap/ConnectionAdapters/AbstractAdapter.html">Keymap::ConnectionAdapters::AbstractAdapter</a>
  
    <li><a href="../../Keymap/ConnectionAdapters/ConnectionHandler.html">Keymap::ConnectionAdapters::ConnectionHandler</a>
  
    <li><a href="../../Keymap/ConnectionAdapters/ConnectionManagement.html">Keymap::ConnectionAdapters::ConnectionManagement</a>
  
    <li><a href="../../Keymap/ConnectionAdapters/ConnectionPool.html">Keymap::ConnectionAdapters::ConnectionPool</a>
  
    <li><a href="../../Keymap/ConnectionAdapters/RedisAdapter.html">Keymap::ConnectionAdapters::RedisAdapter</a>
  
    <li><a href="../../Keymap/ConnectionAdapters/RedisAdapter/RedisHash.html">Keymap::ConnectionAdapters::RedisAdapter::RedisHash</a>
  
    <li><a href="../../Keymap/ConnectionAdapters/RedisAdapter/RedisList.html">Keymap::ConnectionAdapters::RedisAdapter::RedisList</a>
  
    <li><a href="../../Keymap/ConnectionAdapters/TransactionManagement.html">Keymap::ConnectionAdapters::TransactionManagement</a>
  
    <li><a href="../../Keymap/ConnectionNotEstablished.html">Keymap::ConnectionNotEstablished</a>
  
    <li><a href="../../Keymap/ConnectionTimeoutError.html">Keymap::ConnectionTimeoutError</a>
  
    <li><a href="../../Keymap/KeymapError.html">Keymap::KeymapError</a>
  
    <li><a href="../../Keymap/Rollback.html">Keymap::Rollback</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class Keymap::ConnectionAdapters::ConnectionPool</h1>

  <div id="description" class="description">
    
<p>Connection pool base class for managing connections.</p>

<h2 id="label-Introduction">Introduction</h2>

<p>A connection pool synchronizes thread access to a limited number of
connections. The basic idea is that each thread checks out a connection
from the pool, uses that connection, and checks the connection back in. <a
href="ConnectionPool.html">ConnectionPool</a> is completely thread-safe,
and will ensure that a connection cannot be used by two threads at the same
time, as long as ConnectionPool’s contract is correctly followed. It will
also handle cases in which there are more threads than connections: if all
connections have been checked out, and a thread tries to checkout a
connection anyway, then <a href="ConnectionPool.html">ConnectionPool</a>
will wait until some other thread has checked in a connection.</p>

<h2 id="label-Obtaining+%28checking+out%29+a+connection">Obtaining (checking out) a connection</h2>

<p>Connections can be obtained and used from a connection pool in several
ways:</p>
<ol><li>
<p>Simply use <a
href="../Base.html#method-i-connection">Keymap::Base#connection</a>.
Eventually, when you’re done with the connection(s) and wish it to be
returned to the pool, you call <a
href="../Base.html#method-c-clear_active_connections-21">Keymap::Base.clear_active_connections!</a>.</p>
</li><li>
<p>Manually check out a connection from the pool with <a
href="../Base.html#method-c-connection_pool">Keymap::Base.connection_pool</a>.checkout.
You are responsible for returning this connection to the pool when finished
by calling <a
href="../Base.html#method-c-connection_pool">Keymap::Base.connection_pool</a>.checkin(connection).</p>
</li><li>
<p>Use <a
href="../Base.html#method-c-connection_pool">Keymap::Base.connection_pool</a>.<a
href="ConnectionPool.html#method-i-with_connection">#with_connection</a>(&amp;block),
which obtains a connection, yields it as the sole argument to the block,
and returns it to the pool after the block completes.</p>
</li></ol>

<p>Connections in the pool are actually <a
href="AbstractAdapter.html">AbstractAdapter</a> objects (or objects
compatible with AbstractAdapter’s interface).</p>

<h2 id="label-Options">Options</h2>

<p>There are two connection-pooling-related options that you can add to your
database connection configuration:</p>
<ul><li>
<p><code>pool</code>: number indicating size of connection pool (default 5)</p>
</li><li>
<p>+checkout _timeout+: number of seconds to block and wait for a  connection
before giving up and raising a timeout error  (default 5 seconds).</p>
</li></ul>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    
    <!-- Attributes -->
    <section id="attribute-method-details" class="method-section section">
      <h3 class="section-header">Attributes</h3>

      
      <div id="attribute-i-automatic_reconnect" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">automatic_reconnect</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-connections" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">connections</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-spec" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">spec</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
    </section><!-- attribute-method-details -->
    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(spec)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Creates a new <a href="ConnectionPool.html">ConnectionPool</a> object.
<code>spec</code> is a ConnectionSpecification object which describes
database connection information (e.g. adapter, host name, username,
password, etc), as well as the maximum size for this <a
href="ConnectionPool.html">ConnectionPool</a>.</p>

<p>The default <a href="ConnectionPool.html">ConnectionPool</a> maximum size
is 5.</p>
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 67</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">spec</span>)
  <span class="ruby-keyword">super</span>()

  <span class="ruby-ivar">@spec</span> = <span class="ruby-identifier">spec</span>

  <span class="ruby-comment"># The cache of reserved connections mapped to threads</span>
  <span class="ruby-ivar">@reserved_connections</span> = {}

  <span class="ruby-ivar">@queue</span> = <span class="ruby-identifier">new_cond</span>
  <span class="ruby-comment"># 'wait_timeout', the backward-compatible key, conflicts with spec key </span>
  <span class="ruby-comment"># used by mysql2 for something entirely different, checkout_timeout</span>
  <span class="ruby-comment"># preferred to avoid conflict and allow independent values. </span>
  <span class="ruby-ivar">@timeout</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">config</span>[<span class="ruby-value">:checkout_timeout</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">config</span>[<span class="ruby-value">:wait_timeout</span>] <span class="ruby-operator">||</span> <span class="ruby-value">5</span>

  <span class="ruby-comment"># default max pool size to 5</span>
  <span class="ruby-ivar">@size</span> = (<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">config</span>[<span class="ruby-value">:pool</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">config</span>[<span class="ruby-value">:pool</span>].<span class="ruby-identifier">to_i</span>) <span class="ruby-operator">||</span> <span class="ruby-value">5</span>

  <span class="ruby-ivar">@connections</span> = []
  <span class="ruby-ivar">@automatic_reconnect</span> = <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
    </section><!-- public-class-method-details -->
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-active_connection-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">active_connection?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Is there an open connection that is being used for the current thread?</p>
          

          
          <div class="method-source-code" id="active_connection-3F-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 100</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">active_connection?</span>
  <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@reserved_connections</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">current_connection_id</span>) {
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
    }.<span class="ruby-identifier">in_use?</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- active_connection-3F-source -->
          
        </div>

        

        
      </div><!-- active_connection-3F-method -->

    
      <div id="method-i-checkin" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">checkin</span><span
            class="method-args">(conn)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Check-in a database connection back into the pool, indicating that you no
longer need this connection.</p>

<p><code>conn</code>: an <a href="AbstractAdapter.html">AbstractAdapter</a>
object, which was obtained by earlier by calling <code>checkout</code> on
this pool.</p>
          

          
          <div class="method-source-code" id="checkin-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 251</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">checkin</span>(<span class="ruby-identifier">conn</span>)
  <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">run_callbacks</span> <span class="ruby-value">:checkin</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">expire</span>
      <span class="ruby-ivar">@queue</span>.<span class="ruby-identifier">signal</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">release</span> <span class="ruby-identifier">conn</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- checkin-source -->
          
        </div>

        

        
      </div><!-- checkin-method -->

    
      <div id="method-i-checkout" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">checkout</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Check-out a database connection from the pool, indicating that you want to
use it. You should call <a
href="ConnectionPool.html#method-i-checkin">checkin</a> when you no longer
need this.</p>

<p>This is done by either returning an existing connection, or by creating a
new connection. If the maximum number of connections for this pool has
already been reached, but the pool is empty (i.e. they’re all being used),
then this method will wait until a thread has checked in a connection. The
wait time is bounded however: if no connection can be checked out within
the timeout specified for this pool, then a <a
href="../ConnectionTimeoutError.html">ConnectionTimeoutError</a> exception
will be raised.</p>

<p>Returns: an <a href="AbstractAdapter.html">AbstractAdapter</a> object.</p>

<p>Raises:</p>
<ul><li>
<p>ConnectionTimeoutError: no connection can be obtained from the pool within
the timeout period.</p>
</li></ul>
          

          
          <div class="method-source-code" id="checkout-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 204</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">checkout</span>
  <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">waited_time</span> = <span class="ruby-value">0</span>

    <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">conn</span> = <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">lease</span> }

      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">conn</span>
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@size</span>
          <span class="ruby-identifier">conn</span> = <span class="ruby-identifier">checkout_new_connection</span>
          <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">lease</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>
        <span class="ruby-identifier">checkout_and_verify</span> <span class="ruby-identifier">conn</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">conn</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">waited_time</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@timeout</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConnectionTimeoutError</span>, <span class="ruby-node">&quot;could not obtain a database connection#{&quot; within #@timeout seconds&quot; if @timeout} (waited #{waited_time} seconds). The max pool size is currently #@size; consider increasing it.&quot;</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment"># Sometimes our wait can end because a connection is available,</span>
      <span class="ruby-comment"># but another thread can snatch it up first. If timeout hasn't</span>
      <span class="ruby-comment"># passed but no connection is avail, looks like that happened --</span>
      <span class="ruby-comment"># loop and wait again, for the time remaining on our timeout. </span>
      <span class="ruby-identifier">before_wait</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
      <span class="ruby-ivar">@queue</span>.<span class="ruby-identifier">wait</span>([<span class="ruby-ivar">@timeout</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">waited_time</span>, <span class="ruby-value">0</span>].<span class="ruby-identifier">max</span>)
      <span class="ruby-identifier">waited_time</span> <span class="ruby-operator">+=</span> (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">before_wait</span>)

      <span class="ruby-comment"># Will go away in Rails 4, when we don't clean up</span>
      <span class="ruby-comment"># after leaked connections automatically anymore. Right now, clean</span>
      <span class="ruby-comment"># up after we've returned from a 'wait' if it looks like it's</span>
      <span class="ruby-comment"># needed, then loop and try again. </span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">active_connections</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">size</span>
        <span class="ruby-identifier">clear_stale_cached_connections!</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- checkout-source -->
          
        </div>

        

        
      </div><!-- checkout-method -->

    
      <div id="method-i-clear_reloadable_connections-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clear_reloadable_connections!</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Clears the cache which maps classes.</p>
          

          
          <div class="method-source-code" id="clear_reloadable_connections-21-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 146</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">clear_reloadable_connections!</span>
  <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@reserved_connections</span> = {}
    <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">checkin</span> <span class="ruby-identifier">conn</span>
      <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">disconnect!</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">requires_reloading?</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">delete_if</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">requires_reloading?</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- clear_reloadable_connections-21-source -->
          
        </div>

        

        
      </div><!-- clear_reloadable_connections-21-method -->

    
      <div id="method-i-clear_stale_cached_connections-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clear_stale_cached_connections!</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Return any checked-out connections back to the pool by threads that are no
longer alive.</p>
          

          
          <div class="method-source-code" id="clear_stale_cached_connections-21-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 172</span>
      <span class="ruby-keyword">def</span> <span class="ruby-identifier">clear_stale_cached_connections!</span>
        <span class="ruby-identifier">keys</span> = <span class="ruby-ivar">@reserved_connections</span>.<span class="ruby-identifier">keys</span> <span class="ruby-operator">-</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">list</span>.<span class="ruby-identifier">find_all</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">t</span>.<span class="ruby-identifier">alive?</span>
        }.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">thread</span><span class="ruby-operator">|</span> <span class="ruby-identifier">thread</span>.<span class="ruby-identifier">object_id</span> }
        <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">conn</span> = <span class="ruby-ivar">@reserved_connections</span>[<span class="ruby-identifier">key</span>]
          <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">Deprecation</span>.<span class="ruby-identifier">warn</span>(<span class="ruby-string">&quot;Database connections will not be closed automatically, please close your
database connection at the end of the thread by calling `close` on your
connection.  For example: Keymap::Base.connection.close
&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">in_use?</span>
          <span class="ruby-identifier">checkin</span> <span class="ruby-identifier">conn</span>
          <span class="ruby-ivar">@reserved_connections</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">key</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span></pre>
          </div><!-- clear_stale_cached_connections-21-source -->
          
        </div>

        

        
      </div><!-- clear_stale_cached_connections-21-method -->

    
      <div id="method-i-connected-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">connected?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns true if a connection has already been opened.</p>
          

          
          <div class="method-source-code" id="connected-3F-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 129</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">connected?</span>
  <span class="ruby-identifier">synchronize</span> { <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">any?</span> }
<span class="ruby-keyword">end</span></pre>
          </div><!-- connected-3F-source -->
          
        </div>

        

        
      </div><!-- connected-3F-method -->

    
      <div id="method-i-connection" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">connection</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Retrieve the connection associated with the current thread, or call <a
href="ConnectionPool.html#method-i-checkout">checkout</a> to obtain one if
necessary.</p>

<p><a href="ConnectionPool.html#method-i-connection">connection</a> can be
called any number of times; the connection is held in a hash keyed by the
thread id.</p>
          

          
          <div class="method-source-code" id="connection-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 93</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">connection</span>
  <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@reserved_connections</span>[<span class="ruby-identifier">current_connection_id</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">checkout</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- connection-source -->
          
        </div>

        

        
      </div><!-- connection-method -->

    
      <div id="method-i-disconnect-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">disconnect!</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Disconnects all connections in the pool, and clears the pool.</p>
          

          
          <div class="method-source-code" id="disconnect-21-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 134</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">disconnect!</span>
  <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@reserved_connections</span> = {}
    <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">checkin</span> <span class="ruby-identifier">conn</span>
      <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">disconnect!</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-ivar">@connections</span> = []
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- disconnect-21-source -->
          
        </div>

        

        
      </div><!-- disconnect-21-method -->

    
      <div id="method-i-release_connection" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">release_connection</span><span
            class="method-args">(with_id = current_connection_id)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Signal that the thread is finished with the current connection. <a
href="ConnectionPool.html#method-i-release_connection">release_connection</a>
releases the connection-thread association and returns the connection to
the pool.</p>
          

          
          <div class="method-source-code" id="release_connection-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 111</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">release_connection</span>(<span class="ruby-identifier">with_id</span> = <span class="ruby-identifier">current_connection_id</span>)
  <span class="ruby-identifier">conn</span> = <span class="ruby-identifier">synchronize</span> { <span class="ruby-ivar">@reserved_connections</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">with_id</span>) }
  <span class="ruby-identifier">checkin</span> <span class="ruby-identifier">conn</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- release_connection-source -->
          
        </div>

        

        
      </div><!-- release_connection-method -->

    
      <div id="method-i-with_connection" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">with_connection</span><span
            class="method-args">() { |connection| ... }</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>If a connection already exists yield it to the block. If no connection
exists checkout a connection, yield it to the block, and checkin the
connection when finished.</p>
          

          
          <div class="method-source-code" id="with_connection-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 119</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">with_connection</span>
  <span class="ruby-identifier">fresh_connection</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-identifier">connection_id</span> = <span class="ruby-identifier">current_connection_id</span>
  <span class="ruby-identifier">fresh_connection</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">active_connection?</span>
  <span class="ruby-keyword">yield</span> <span class="ruby-identifier">connection</span>
<span class="ruby-keyword">ensure</span>
  <span class="ruby-identifier">release_connection</span>(<span class="ruby-identifier">connection_id</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">fresh_connection</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- with_connection-source -->
          
        </div>

        

        
      </div><!-- with_connection-method -->

    
    </section><!-- public-instance-method-details -->
  
     <section id="private-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Private Instance Methods</h3>

    
      <div id="method-i-active_connections" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">active_connections</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="active_connections-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 301</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">active_connections</span>
  <span class="ruby-ivar">@connections</span>.<span class="ruby-identifier">find_all</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">in_use?</span> }
<span class="ruby-keyword">end</span></pre>
          </div><!-- active_connections-source -->
          
        </div>

        

        
      </div><!-- active_connections-method -->

    
      <div id="method-i-checkout_and_verify" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">checkout_and_verify</span><span
            class="method-args">(c)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="checkout_and_verify-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 294</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">checkout_and_verify</span>(<span class="ruby-identifier">c</span>)
  <span class="ruby-identifier">c</span>.<span class="ruby-identifier">run_callbacks</span> <span class="ruby-value">:checkout</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">c</span>.<span class="ruby-identifier">verify!</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">c</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- checkout_and_verify-source -->
          
        </div>

        

        
      </div><!-- checkout_and_verify-method -->

    
      <div id="method-i-checkout_new_connection" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">checkout_new_connection</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="checkout_new_connection-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 285</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">checkout_new_connection</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConnectionNotEstablished</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@automatic_reconnect</span>

  <span class="ruby-identifier">c</span> = <span class="ruby-identifier">new_connection</span>
  <span class="ruby-identifier">c</span>.<span class="ruby-identifier">pool</span> = <span class="ruby-keyword">self</span>
  <span class="ruby-ivar">@connections</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">c</span>
  <span class="ruby-identifier">c</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- checkout_new_connection-source -->
          
        </div>

        

        
      </div><!-- checkout_new_connection-method -->

    
      <div id="method-i-new_connection" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_connection</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_connection-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 277</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_connection</span>
  <span class="ruby-constant">Keymap</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">adapter_method</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">config</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_connection-source -->
          
        </div>

        

        
      </div><!-- new_connection-method -->

    
      <div id="method-i-release" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">release</span><span
            class="method-args">(conn)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="release-source">
            <pre><span class="ruby-comment"># File lib/keymap/connection_adapters/abstract/connection_pool.rb, line 264</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">release</span>(<span class="ruby-identifier">conn</span>)
  <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@reserved_connections</span>[<span class="ruby-identifier">current_connection_id</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">conn</span>
      <span class="ruby-identifier">thread_id</span> = <span class="ruby-identifier">current_connection_id</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">thread_id</span> = <span class="ruby-ivar">@reserved_connections</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span>
        <span class="ruby-ivar">@reserved_connections</span>[<span class="ruby-identifier">k</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">conn</span>
      }
    <span class="ruby-keyword">end</span>
    <span class="ruby-ivar">@reserved_connections</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">thread_id</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">thread_id</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- release-source -->
          
        </div>

        

        
      </div><!-- release-method -->

    
    </section><!-- private-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

